<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alticator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .logo {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #2C3E50;
            letter-spacing: -1px;
            display: inline-block;
            line-height: 1;
            margin: 0;
            padding: 0;
        }
        .logo span {
            color: #3498DB;
            display: inline-block;
            line-height: 1;
            margin: 0;
            padding: 0;
        }
        .logo-emoji {
            font-size: 2.5rem;
            vertical-align: bottom;
            margin-right: 0.3rem;
            position: relative;
            line-height: 1;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="mb-4">
            <h1 class="logo"><span class="logo-emoji">ðŸ“ˆ</span>Alti<span>cator</span></h1>
        </div>
        
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-danger">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="card mb-4">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#manual">Manual Input</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#csv">CSV Upload</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <div class="tab-pane fade" id="manual">
                        <form method="POST">
                            <div class="mb-3">
                                <label for="tickers" class="form-label">Tickers (space-separated)</label>
                                <input type="text" class="form-control" id="tickers" name="tickers" 
                                       placeholder="AAPL MSFT GOOGL">
                            </div>
                            
                            <div class="mb-3">
                                <label for="weights" class="form-label">Weights (space-separated, must sum to 1)</label>
                                <input type="text" class="form-control" id="weights" name="weights" 
                                       placeholder="0.4 0.3 0.3">
                                <small class="text-muted">Example: 0.4 0.3 0.3</small>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Analyze Portfolio</button>
                        </form>
                    </div>
                    <div class="tab-pane fade show active" id="csv">
                        <form method="POST" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="portfolio_file" class="form-label">Upload Portfolio CSV</label>
                                <input type="file" class="form-control" id="portfolio_file" 
                                       name="portfolio_file" accept=".csv">
                                <small class="text-muted">CSV format: ticker,weight<br>
                                ðŸ’¡ Tip: Non-ticker inputs for other asset classes ("Art, Crypto") are allowed but won't show returns</small>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload and Analyze</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {% if portfolio %}
        <div class="card mt-4">
            <div class="card-body">
                <h3>Current Portfolio</h3>
                <div class="mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active" data-interval="1d">Daily</button>
                        <button type="button" class="btn btn-outline-primary" data-interval="1wk">Weekly</button>
                        <button type="button" class="btn btn-outline-primary" data-interval="1mo">Monthly</button>
                    </div>
                </div>
                
                <div id="portfolio-chart" class="mb-4" style="height: 400px;"></div>
                
                {% if not simulation %}
                <div class="row">
                    <div class="col-md-6">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Asset</th>
                                    <th>Weight</th>
                                    <th>YTD Return</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in portfolio %}
                                <tr>
                                    <td>{{ row.ticker }}</td>
                                    <td>{{ "%.2f"|format(row.weight * 100) }}%</td>
                                    <td>
                                        {% if row.ytd_return is none %}
                                            N/A
                                        {% else %}
                                            {{ "%.2f"|format(row.ytd_return * 100) }}%
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <h6>Portfolio Return: {{ "%.2f"|format(result * 100) }}%</h6>
                    </div>
                </div>
                {% endif %}

                <!-- Simulation Form -->
                <div class="mt-4">
                    <h4>Simulate Portfolio Change</h4>
                    <form method="POST" action="{{ url_for('simulate') }}">
                        <div class="mb-3">
                            <label for="new_asset" class="form-label">New Asset</label>
                            <input type="text" class="form-control" id="new_asset" name="new_asset" required>
                            <small class="text-muted">Enter ticker symbol or asset name (e.g., "Art", "Real Estate")</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="new_weight" class="form-label">Weight (%)</label>
                            <input type="number" class="form-control" id="new_weight" name="new_weight" 
                                   min="0" max="100" step="0.01" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="manual_return" class="form-label">Manual Return Rate (%)</label>
                            <input type="number" class="form-control" id="manual_return" name="manual_return" 
                                   min="-100" max="1000" step="0.01">
                            <small class="text-muted">Optional: Enter YTD return for non-ticker assets</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Rebalance Method</label>
                            <select class="form-select" name="rebalance_method">
                                <option value="proportional">Proportional</option>
                                <option value="largest">Reduce Largest</option>
                                <option value="worst">Reduce Worst Performing</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Simulate Change</button>
                    </form>
                </div>

                {% if simulation %}
                <div class="mt-4">
                    <h4>Simulation Results</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Original Portfolio</h5>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Weight</th>
                                        <th>YTD Return</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in portfolio %}
                                    <tr>
                                        <td>{{ row.ticker }}</td>
                                        <td>{{ "%.2f"|format(row.weight * 100) }}%</td>
                                        <td>
                                            {% if row.ytd_return is none %}
                                                N/A
                                            {% else %}
                                                {{ "%.2f"|format(row.ytd_return * 100) }}%
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <h6>Portfolio Return: {{ "%.2f"|format(result * 100) }}%</h6>
                        </div>
                        <div class="col-md-6">
                            <h5>Simulated Portfolio</h5>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Weight</th>
                                        <th>YTD Return</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in simulation_portfolio if row.ticker and row.ticker != 'nan' and row.ticker != '' %}
                                    <tr>
                                        <td>{{ row.ticker }}</td>
                                        <td>{{ "%.2f"|format(row.weight * 100) }}%</td>
                                        <td>
                                            {% if row.ytd_return is none %}
                                                N/A
                                            {% else %}
                                                {{ "%.2f"|format(row.ytd_return * 100) }}%
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <h6>Portfolio Return: {{ "%.2f"|format(simulation_return * 100) }}%</h6>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Portfolio historical data
        const historicalData = {{ historical_data | tojson | safe }};
        const portfolioHist = {{ portfolio_hist | tojson | safe }};
        
        // Only create chart if we have data
        if (Object.keys(portfolioHist).length > 0) {
            // Create initial chart
            function createChart(data) {
                const traces = [{
                    x: Object.keys(data.original),
                    y: Object.values(data.original),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Original Portfolio',
                    line: {
                        color: '#3498DB'
                    }
                }];
                
                // Add simulation trace if it exists
                if (data.simulation) {
                    traces.push({
                        x: Object.keys(data.simulation),
                        y: Object.values(data.simulation),
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Simulated Portfolio',
                        line: {
                            color: '#E74C3C'
                        }
                    });
                }
                
                const layout = {
                    title: 'Portfolio Performance',
                    xaxis: {
                        title: 'Date'
                    },
                    yaxis: {
                        title: 'Return',
                        tickformat: '.1%',
                        hoverformat: '.2%',
                        gridcolor: '#E1E5EA',
                        zerolinecolor: '#2C3E50'
                    },
                    plot_bgcolor: 'white',
                    paper_bgcolor: 'white',
                    showlegend: true,
                    legend: {
                        x: 1.1,
                        xanchor: 'left',
                        y: 1,
                        yanchor: 'top'
                    },
                    margin: {
                        r: 150  // Add right margin to make room for legend
                    },
                    hovermode: 'x unified'
                };
                
                Plotly.newPlot('portfolio-chart', traces, layout);
            }
            
            // Initialize chart
            createChart({
                original: portfolioHist,
                simulation: {{ simulation_portfolio_hist | default({}) | tojson | safe }}
            });
            
            // Handle interval changes
            document.querySelectorAll('[data-interval]').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const interval = e.target.dataset.interval;
                    const response = await fetch(`/historical-data?interval=${interval}`);
                    const data = await response.json();
                    createChart({
                        original: data.portfolio_hist,
                        simulation: data.simulation_hist
                    });
                    
                    // Update active button
                    document.querySelectorAll('[data-interval]').forEach(btn => 
                        btn.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });
        }
    </script>
</body>
</html> 